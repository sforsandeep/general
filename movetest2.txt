using Azure;
using Azure.Storage.Files.DataLake;
using Azure.Identity;
using System;
using System.IO;

namespace BlobStorageDemo
{
    class Program
    {
        static void Main(string[] args)
        {
            string sourceFilePath = "general/landing/test/2023/8/16/file1.txt";
            string destinationPath = "secure/folder/test/2023/8/18";
            string fileName = "file.txt"; 

            MoveFile(sourceFilePath, destinationPath, fileName);
        }

        static void MoveFile(string sourceFilePath, string destinationPath, string fileName)
        {
            string accountName = "your_storage_account_name";
            string serviceUrl = $"https://{accountName}.dfs.core.windows.net";

            var credential = new DefaultAzureCredential();

            string sourceContainer = sourceFilePath.Split('/')[0];
            string sourceFileSubPath = Path.Combine(sourceFilePath.Substring(sourceContainer.Length + 1), fileName);
            string destinationContainer = destinationPath.Split('/')[0];
            string destinationFileSubPath = Path.Combine(destinationPath.Substring(destinationContainer.Length + 1), fileName);

            var sourceDataLakeClient = new DataLakeFileSystemClient(new Uri($"{serviceUrl}/{sourceContainer}"), credential);
            var destinationDataLakeClient = new DataLakeFileSystemClient(new Uri($"{serviceUrl}/{destinationContainer}"), credential);

            var sourceDataLakeFileClient = sourceDataLakeClient.GetFileClient(sourceFileSubPath);

            // Ensure the destination path exists
            var destinationDirectoryClient = destinationDataLakeClient.GetDirectoryClient(Path.GetDirectoryName(destinationFileSubPath));
            destinationDirectoryClient.CreateIfNotExists();

            var destinationDataLakeFileClient = destinationDataLakeClient.GetFileClient(destinationFileSubPath);

            if (sourceDataLakeFileClient.Exists())
            {
                // Start the copy operation from source to destination
                destinationDataLakeFileClient.StartCopyFromUri(new Uri(sourceDataLakeFileClient.Uri.ToString()));

                // Verify that copy has completed, for demonstration purposes.
                while (destinationDataLakeFileClient.GetProperties().Value.CopyStatus == Azure.Storage.Blobs.Models.CopyStatus.Pending)
                {
                    System.Threading.Thread.Sleep(1000);
                }

                if (destinationDataLakeFileClient.GetProperties().Value.CopyStatus == Azure.Storage.Blobs.Models.CopyStatus.Success)
                {
                    // After the successful copy, delete the file from the source container.
                    sourceDataLakeFileClient.DeleteIfExists();
                }
            }
            else
            {
                Console.WriteLine("Source file does not exist.");
            }
        }
    }
}
